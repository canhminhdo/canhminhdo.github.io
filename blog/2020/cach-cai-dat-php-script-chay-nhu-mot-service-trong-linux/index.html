<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content="google652b6e851dbdf40b.html"> <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Cách cài đặt PHP script chạy như một service trong Linux | Canh Minh Do</title> <meta name="author" content="Canh Minh Do"> <meta name="description" content="Computer Science, Software Engineering, Formal Methods. "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/bio-photo.png"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://canhminhdo.github.io/blog/2020/cach-cai-dat-php-script-chay-nhu-mot-service-trong-linux/"> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Canh </span>Minh Do</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item "> <a class="nav-link" href="/profile/">Profile</a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">Teaching</a> </li> <li class="nav-item "> <a class="nav-link" href="/research/">Research</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/news/">News</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Cách cài đặt PHP script chạy như một service trong Linux</h1> <p class="post-meta">December 20, 2020</p> <p class="post-tags"> <a href="/blog/2020"> <i class="fas fa-calendar fa-sm"></i> 2020 </a>   ·   <a href="/blog/tag/linux"> <i class="fas fa-hashtag fa-sm"></i> Linux</a>   <a href="/blog/tag/php"> <i class="fas fa-hashtag fa-sm"></i> PHP</a>     ·   <a href="/blog/category/deployment"> <i class="fas fa-tag fa-sm"></i> Deployment</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Trước khi hướng dẫn deploy một PHP script chạy như một service trong Linux. Chúng ta cùng tìm hiểu tại sao chúng ta cần phải làm như vậy thay vì sử dụng <code class="language-plaintext highlighter-rouge">crontab</code>, <code class="language-plaintext highlighter-rouge">screen</code>.</p> <p>Việc chạy PHP script như một service trong Linux, thực chất là viết một đoạn bash script để chạy chương trình của bạn với <code class="language-plaintext highlighter-rouge">nohup</code>, sẽ có một vài ưu điểm bạn có thể cân nhắc:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">nohup</code> được sử dụng cho tiến trình ngầm khi tiến trình đó không sử dụng đầu vào từ user chẳng hạn như những batch job.</li> <li> <code class="language-plaintext highlighter-rouge">nohub</code> sẽ chạy trên một tiến trình độc lập, bạn có thể dễ dàng <code class="language-plaintext highlighter-rouge">start</code>, <code class="language-plaintext highlighter-rouge">stop</code>, <code class="language-plaintext highlighter-rouge">status</code> và <code class="language-plaintext highlighter-rouge">restart</code> </li> <li>Tránh những trường hợp không may ấn tổ hợp phím để dừng một tiến trình trong <code class="language-plaintext highlighter-rouge">screen</code> như <code class="language-plaintext highlighter-rouge">Ctrl' + </code>C`</li> <li>Thông tin log sẽ được viết xuống một file được chỉ định, dễ dàng cho việc kiểm tra lỗi.</li> <li>Hoạt động hiệu quả và tốn ít bộ nhớ.</li> </ul> <p>Dưới đây là cách deploy một PHP script chạy như một service trong Linux. Bạn cần có quyền của root để có thể làm điều này.</p> <ol> <li> <p>Đầu tiên bạn tạo một file dưới thư mục <strong>/etc/init.d</strong> bằng trình soạn thảo bạn quen thuộc như vi hoặc emacs. Ví dụ mình tạo một file là <strong>import_test_case</strong> thì sẽ tạo như sau <strong>vi /etc/init.d/import_test_case</strong>.</p> </li> <li> <p>Thay đổi một vài thông tin trong file bash script ở bên dưới. Như là SERVICE_NAME, PATH_TO_PROJECT, PATH_TO_LOG, COMMAND để script biết được tên của service, vị trí của dự án, vị trí để viết file log, command sẽ thực hiện.</p> </li> <li> <p>Cho phép file bạn vừa tạo có thể chạy bằng lệnh <strong>sudo chmod +x /etc/init.d/import_test_case</strong></p> </li> <li> <p>Một vài lệnh bạn có thể kiểm tra với service mới bạn định sử dụng</p> </li> </ol> <ul> <li>chạy service bằng lệnh <strong>service import_test_case start</strong> </li> <li>dừng service bằng lệnh <strong>service import_test_case stop</strong> </li> <li>khởi động lại service bằng lệnh <strong>service import_test_case restart</strong> </li> <li>kiểm tra trạng thái của service bằng lệnh <strong>service import_test_case status</strong> </li> </ul> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/sh</span>
<span class="nv">SERVICE_NAME</span><span class="o">=</span>import_test_case_dev
<span class="nv">WORKER_ID</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">PROJECT_NAME</span><span class="o">=</span>dev.manage-test.com
<span class="nv">PATH_TO_PROJECT</span><span class="o">=</span><span class="s2">"/var/www/html/</span><span class="k">${</span><span class="nv">PROJECT_NAME</span><span class="k">}</span><span class="s2">"</span>
<span class="nv">PATH_TO_CONSOLE</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">PATH_TO_PROJECT</span><span class="k">}</span><span class="s2">/lib/Cake/Console"</span>
<span class="nv">PATH_TO_LOG</span><span class="o">=</span><span class="s2">"/home/mtest/rabbitmq/</span><span class="k">${</span><span class="nv">SERVICE_NAME</span><span class="k">}</span><span class="s2">_worker</span><span class="k">${</span><span class="nv">WORKER_ID</span><span class="k">}</span><span class="s2">.log"</span>
<span class="nv">PID_PATH_NAME</span><span class="o">=</span><span class="s2">"/home/mtest/rabbitmq/</span><span class="k">${</span><span class="nv">SERVICE_NAME</span><span class="k">}</span><span class="s2">_worker</span><span class="k">${</span><span class="nv">WORKER_ID</span><span class="k">}</span><span class="s2">_pid"</span>
<span class="nv">COMMAND</span><span class="o">=</span><span class="s2">"php -q </span><span class="k">${</span><span class="nv">PATH_TO_CONSOLE</span><span class="k">}</span><span class="s2">/cake.php -working </span><span class="k">${</span><span class="nv">PATH_TO_PROJECT</span><span class="k">}</span><span class="s2"> ImportTestCase"</span>

<span class="k">case</span> <span class="nv">$1</span> <span class="k">in
    </span>start<span class="p">)</span>
        <span class="nb">echo</span> <span class="s2">"Starting </span><span class="nv">$SERVICE_NAME</span><span class="s2"> ..."</span>
        <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="nv">$PID_PATH_NAME</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
            </span><span class="nb">cd</span> <span class="nv">$PATH_TO_PROJECT</span> <span class="o">&amp;&amp;</span> <span class="nb">nohup</span> <span class="nv">$COMMAND</span> <span class="o">&gt;&gt;</span> <span class="nv">$PATH_TO_LOG</span> 2&gt;&amp;1 &amp;
            <span class="nb">echo</span> <span class="nv">$!</span> <span class="o">&gt;</span> <span class="nv">$PID_PATH_NAME</span>
            <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$SERVICE_NAME</span><span class="s2"> started ..."</span>
        <span class="k">else
            </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$SERVICE_NAME</span><span class="s2"> is already running ..."</span>
        <span class="k">fi</span>
    <span class="p">;;</span>
    status<span class="p">)</span>
        <span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="nv">$PID_PATH_NAME</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
            </span><span class="nv">PID</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat</span> <span class="nv">$PID_PATH_NAME</span><span class="si">)</span><span class="p">;</span>
            <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$SERVICE_NAME</span><span class="s2"> is running at </span><span class="nv">$PID</span><span class="s2"> ..."</span>
        <span class="k">else
            </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$SERVICE_NAME</span><span class="s2"> is not running ..."</span>
        <span class="k">fi</span>
    <span class="p">;;</span>
    stop<span class="p">)</span>
        <span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="nv">$PID_PATH_NAME</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
            </span><span class="nv">PID</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat</span> <span class="nv">$PID_PATH_NAME</span><span class="si">)</span><span class="p">;</span>
            <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$SERVICE_NAME</span><span class="s2"> stoping ..."</span>
            pkill <span class="nt">-P</span> <span class="nv">$PID</span> <span class="o">&amp;&amp;</span> <span class="nb">kill</span> <span class="nv">$PID</span><span class="p">;</span>
            <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$SERVICE_NAME</span><span class="s2"> stopped ..."</span>
            <span class="nb">rm</span> <span class="nv">$PID_PATH_NAME</span>
        <span class="k">else
            </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$SERVICE_NAME</span><span class="s2"> is not running ..."</span>
        <span class="k">fi</span>
    <span class="p">;;</span>
    restart<span class="p">)</span>
        <span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="nv">$PID_PATH_NAME</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
            </span><span class="nv">PID</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat</span> <span class="nv">$PID_PATH_NAME</span><span class="si">)</span><span class="p">;</span>
            <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$SERVICE_NAME</span><span class="s2"> stopping ..."</span><span class="p">;</span>
            pkill <span class="nt">-P</span> <span class="nv">$PID</span> <span class="o">&amp;&amp;</span> <span class="nb">kill</span> <span class="nv">$PID</span><span class="p">;</span>
            <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$SERVICE_NAME</span><span class="s2"> stopped ..."</span><span class="p">;</span>
            <span class="nb">rm</span> <span class="nv">$PID_PATH_NAME</span>
            <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$SERVICE_NAME</span><span class="s2"> starting ..."</span>
            <span class="nb">cd</span> <span class="nv">$PATH_TO_PROJECT</span> <span class="o">&amp;&amp;</span> <span class="nb">nohup</span> <span class="nv">$COMMAND</span> <span class="o">&gt;&gt;</span> <span class="nv">$PATH_TO_LOG</span> 2&gt;&amp;1 &amp;
            <span class="nb">echo</span> <span class="nv">$!</span> <span class="o">&gt;</span> <span class="nv">$PID_PATH_NAME</span>
            <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$SERVICE_NAME</span><span class="s2"> started ..."</span>
        <span class="k">else
            </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$SERVICE_NAME</span><span class="s2"> is not running ..."</span>
        <span class="k">fi</span>
    <span class="p">;;</span>
<span class="k">esac</span></code></pre></figure> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/lvalues-and-rvalues-in-c++/">Lvalues and Rvalues in C++</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/C++-static-library-va-dynamic-library/">C++ static library và dynamic library</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/nhung-luu-y-khi-viet-code-de-chuong-trinh-tro-len-sang-sua-va-mach-lac/">Những lưu ý khi viết code để chương trình trở lên sáng sủa và mạch lạc</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/ban-that-su-da-biet-ve-bit-shifting/">Bạn thật sự đã biết về Bit shifting</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/hash-tables/">Hash tables</a> </li> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0 text-center"> © Copyright 2024 Canh Minh Do. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-163449648-1"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-163449648-1");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>